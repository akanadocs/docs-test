---
layout: page
title: Troubleshooting Policy Manager for DataPower
description: Troubleshooting resources and tips for Policy Manager for DataPower.
product: ag
category: ref
sub-nav-class: Troubleshooting
weight: 09
type: page
nav-title: Troubleshooting PMDP
---
<h1 id="top">Troubleshooting Policy Manager for DataPower</h1>
<p>Information to help you troubleshoot issues that might come up with Policy Manager for DataPower.</p>
<h4 class="stamp">Valid in version: 7.0</h4>
<hr class="divide_hr" />



<h2 style="color: gray;">Table of Contents</h2>
<ol class="table_of_contents">
	<li><a href="#tspmdp_01">General Troubleshooting Points</a></li>
	<li><a href="#tspmdp_02">Firewall Rules</a></li>
	<li><a href="#tspmdp_03">Installation Issues: Certificate Issues</a></li>
	<li><a href="#tspmdp_04">Installation Issues: Network Issues</a></li>
	<li><a href="#tspmdp_05">Deployment Issues: Configuration Errors</a></li>
	<li><a href="#tspmdp_06">Deployment Issues: Deployment Errors</a></li>
	<li><a href="#tspmdp_07">Runtime Issues: Network Issues</a></li>
	<li><a href="#tspmdp_08">Runtime Issues: Security Issues</a></li>
	<li><a href="#tspmdp_09">Runtime Issues: Configuration Issues</a></li>
</ol>
<hr class="divide_hr" />



<h2 id="tspmdp_01">General Troubleshooting Points</h2>
<p>This section includes information about general tools to help you troubleshoot issues, including:</p>
<ul>
	<li><a href="#tspmdp_01_01">Alerts</a></li>
	<li><a href="#tspmdp_01_02">Logs</a></li>
	<li><a href="#tspmdp_01_03">Issue Checklist</a></li>
</ul>


<h3 id="tspmdp_01_01">Alerts</h3>
<p>If you encounter an issue with a specific virtual service, first view the alerts for that service in Policy Manager.</p>


<h3 id="tspmdp_01_02">Logs</h3>
<p>By default, Policy Manager for IBM WebSphere DataPower writes logs to the following folder:</p>
<pre>c:\sm60\instances\&lt;container-name&gt;\logs</pre>
<p>This directory includes two log files:</p>
<ul>
	<li>startup.log</li>
	<li>&lt;container-name&gt;.log</li>
</ul>
<p>When submitting a support ticket to Akana Technical Support (see <a href="ts_pm_nd_01.htm#s01_02">Customer Support</a>), always include both the above log files.</p>


<h3 id="tspmdp_01_03">Issue Checklist</h3>
<p>If you encounter difficulties, check over the list of common issues below. More information about many of these issues is given in the following sections.</p>
<ul>
	<li>Firewall configuration
		<p>Make sure the firewall is configured correctly. Consult the <a href="#tspmdp_02">Firewall Rules</a> section.</p></li>
	<li>Policy Manager version
		<p>Is Policy Manager operating at the correct release and update level, and is it accessible from the Policy Manager for IBM WebSphere DataPower?</p></li>
	<li>Container setup
		<p>Is the DataPower container set up in Policy Manager? Does the container name's key in Policy Manager match the name set up for it in DataPower?</p></li>
	<li>WS-MetadataExchange settings
		<p>Make sure the WS-MetadataExchange options are configured correctly, and that the WS-MEX URL is accessible to Policy Manager for IBM WebSphere DataPower. The address must be a valid address other than localhost or 127.0.0.1.</p></li>
	<li>Database configuration and accessibility
		<p>Policy Manager for DataPower should be able to communicate with the Policy Manager database if the Remote Usage Writer is not enabled for the Policy Manager for DataPower container.</p></li>
	<li>DataPower configuration
		<p>Make sure the DataPower Appliance configuration is correct and that it points to a valid DataPower appliance that is network accessible from the Policy Manager for IBM WebSphere DataPower. The domain and account must be valid and accessible, and the account must have appropriate permission to the domain.</p></li>
	<li>DataPower Appliance
		<p>The DataPower Appliance must be operational, and the XML Management Interface must be enabled and properly configured. The domain must be valid and accessible, and the Policy Manager for DataPower account must have the proper permissions.</p></li>
	<li>Machine time of day
		<p>The machines on which the various DataPower Integration solution components run do not have to be configured for the same time zone, but they must agree on the time of day after factoring in time zone differences. This can be achieved via time synchronization. The machines on which the following components run must agree on time:</p>
		<ul>
			<li>DataPower Appliance</li>
			<li>Policy Manager for IBM WebSphere DataPower</li>
			<li>Akana Platform</li>
			<li>Akana Platform database</li>
		</ul>
		</li>
	<li>Contract Enforcement
	<p>If a consumer accesses a service, one of the following contracts must be in place:</p>
		<ul>
			<li>A contract for that specific consumer, with appropriate authentication policy configuration to authenticate the user before authorizing.</li>
			<li>An anonymous contract.</li>
		</ul>
	</li>
	<li>Contract Authorization Service
		<ul>
			<li>Is the Authorization Service available?</li>
			<li>Is the communication between the DataPower Appliance and Policy Manager happening smoothly without any network interruptions?</li>
		</ul>
	</li>
	<li>Authentication Service
		<ul>
			<li>Is the Authentication Service available on the port specified in the DataPower Security Options?</li>
			<li>Is the container running without errors?</li>
		</ul>
	</li>
	</ul>
<p><a href="#top">Back to top</a></p>



<h2 id="tspmdp_02">Firewall Rules</h2>
<p>This section outlines the firewall rules that must be in place between the various components involved in the solution to allow proper communication between them.</p>
<table class="doctable">
<thead>
	<tr>
		<th>From</th>
		<th>To</th>
		<th>Destination Port</th>
		<th>Reason</th>
	</tr>
	</thead>
	<tbody>
	<tr>
		<td>DataPower Appliance</td>
		<td>Policy Manager for IBM WebSphere DataPower</td>
		<td>Configurable</td>
		<td>Policy Manager for IBM WebSphere DataPower Listener</td>
	</tr>
	<tr>
		<td>Policy Manager for DataPower</td>
		<td>Policy Manager 6.0 Subsystems &quot;WS-MEX&quot; interface</td>
		<td>Usually 9900</td>
		<td>WSDL Access</td>
	</tr>
	<tr>
		<td>Policy Manager for IBM WebSphere DataPower</td>
		<td>Policy Manager 6.0 Database</td>
		<td>Based on database writer</td>
		<td>Database writer is enabled by default. Policy Manager for DataPower must be able to communicate to the database server to write the usage data.</td>
	</tr>
	<tr>
		<td>Policy Manager for IBM WebSphere DataPower</td>
		<td>DataPower Appliance</td>
		<td>Usually 5550</td>
		<td>DataPower Management Interface</td>
	</tr>
	<tr>
		<td>Policy Manager for IBM WebSphere DataPower</td>
		<td>Policy Manager 6.0 Subsystems</td>
		<td>Usually 9900</td>
		<td>Policy Manager 6.0 Subsystems access</td>
	</tr>
	<tr>
		<td>Administrator's Desktop</td>
		<td>Policy Manager for IBM WebSphere DataPower Admin Console</td>
		<td>Configurable</td>
		<td>Administrator access to Admin Console administration tool.</td>
	</tr>
	<tr>
		<td>DataPower Appliance</td>
		<td>Policy Manager for DataPower Authentication Service</td>
		<td>Configurable</td>
		<td>For authentication, DataPower makes a call to the Policy Manager for DataPower Authentication Service.</td>
	</tr>
	<tr>
		<td>DataPower Appliance</td>
		<td>Policy Manager for DataPower Listener</td>
		<td>Configurable</td>
		<td>To send alerts to Policy Manager for DataPower and DataPower</td>
	</tr>
	</tbody>
</table>



<h2 id="tspmdp_03">Installation Issues: Certificate Issues</h2>
<p>Installation issues that might crop up relating to security certificates include:</p>
<ul>
	<li><a href="#tspmdp_03_01">Primary/Secondary Configuration: Secondary Container Does Not Work</a></li>
	<li><a href="#tspmdp_03_02">Standalone Configuration: HTTPS Listener Certificate Missing</a></li>
	<li><a href="#tspmdp_03_03">User Certificate Expiring</a></li>
	<li><a href="#tspmdp_03_04">New Certificate from Different Certificate Authority</a></li>
</ul>


<h3 id="tspmdp_03_01">Primary/Secondary Configuration: Secondary Container Does Not Work</h3>
<p>If you are using primary/secondary configuration, and the secondary container is not working, it could be due to a certificate issue. Make sure you have the same certificate, correct Governed Domain Container Key, and appropriate DataPower Domain configured for both primary container and secondary container.</p>
<p>Normally, if you have a primary/secondary setup, the secondary container startup alert message is seen on the primary container's monitoring tab. However, if you don't have the same certificate set up for both, this does not occur.</p>


<h3 id="tspmdp_03_02">Standalone Configuration: HTTPS Listener Certificate Missing</h3>
<p>If there is an HTTPS listener inside Policy Manager, but there is no certificate for the listener, you would see that the listener is not deployed onto DataPower, and you would see error messages on the Policy Manager for DataPower governed domain container's monitoring tab.</p>
<p>Also, when configuring the HTTPS Container Listener, in the <strong>Client Certificates</strong> field, if you choose the <strong>ignore client certificates</strong> option, the HTTPS listener will not be deployed onto DataPower, and you will see &quot;Deployment failure" error messages on the container monitoring tab. The example below shows HTTPS listener settings, with Client Certificates set to <strong>accept client certificates</strong>.</p>
<p><img src="assets/pmdp_01.jpg" alt="Configuring the listener certificate" /></p>


<h3 id="tspmdp_03_03">User Certificate Expiring</h3>
<p class="apidoc_note"><strong>Note</strong>: This issue applies both to primary/secondary and standalone configurations.</p>
<p>When the user certificate is expiring, and you get a new certificate, you must update the certificate in two places:</p>
<ul>
	<li><strong>Akana Administration Console</strong>: Go to the Akana Administration Console for the Policy Manager for DataPower container, and upload the new certificate.</li>
	<li><strong>Policy Manager</strong>: Go to the Policy Manager console and update the Policy Manager for DataPower instance container certificate.</li>
</ul>
<p>It's important to make the update in both places.</p>


<h3 id="tspmdp_03_04">New Certificate from Different Certificate Authority</h3>
<p>When updating the certificate, if the new certificate is issued by a different certificate authority (CA), it's also necessary to upload the new CA certificate to the Policy Manager Trust Store. If you omit this step, Policy Manager will not accept any certificates issued by the new CA.</p>
<p><a href="#top">Back to top</a></p>



<h2 id="tspmdp_04">Installation Issues: Network Issues</h2>
<p>This section provides information about network issues that might occur with Policy Manager for DataPower, including:</p>
<ul>
	<li><a href="#tspmdp_04_01">Communication Issue between Policy Manager for DataPower and Policy Manager</a></li>
	<li><a href="#tspmdp_04_02">Communication Issue between Policy Manager for DataPower and DataPower</a></li>
	<li><a href="#tspmdp_04_03">Incorrect Port Configurations</a></li>
	<li><a href="#tspmdp_04_04">Incorrect Permissions on DataPower</a></li>
</ul>


<h3 id="tspmdp_04_01">Communication issue between Policy Manager for DataPower and Policy Manager</h3>
<p>Policy Manager for DataPower must be able to communicate with Policy Manager at all time.</p>
<p>If there is a communication issue between Policy Manager for DataPower and Policy Manager, these general issues might be the reason:</p>
<ul>
	<li>Network issue</li>
	<li>DNS entries missing or incorrect</li>
	<li>Instance container certificate already in use within Policy Manager by another container</li>
	<li>Incorrect port number</li>
	<li><a href="#tspmdp_04_01_05">Error in WS-Mex URL</a></li>
</ul>
<p>To help ensure a successful installation, make sure all the network firewall rules, DNS entries, and any other steps are completed prior to installation.</p>
<p>If there is a problem, check in the Policy Manager for DataPower container's log file to see what errors are being generated. For example, you might see one of the following error messages in the Policy Manager for DataPower log file:</p>
<pre>404 exception in WS_MEX URL.
Unable to connect to container state service.</pre>


<h4 id="tspmdp_04_01_05">Error in WS-Mex URL</h4>
<p>If there is a communication problem between Policy Manager for DataPower and Policy Manager, check the WS-Mex URL in the Akana Administration Console for Policy Manager for DataPower (WS-MetaDataExchange Options, see below). If there is a typo in the URL, an incorrect port number, or any other error, Policy Manager for DataPower will not be able to communicate with Policy Manager.</p>
<p><img src="assets/pmdp_02.jpg" alt="Error in WS-Mex URL" /></p>


<h3 id="tspmdp_04_02">Communication issue Between Policy Manager for DataPower and DataPower</h3>
<p>For any kind of communication issue between Policy Manager for DataPower and DataPower, check the following:</p>
<ul>
	<li>Make sure there are no network issues. This should always be the first step.</li>
	<li>Make sure the DNS entries are properly configured. You might need to add some hostname aliases.</li>
</ul>
<p>The above are basic troubleshooting steps for any communication between two different boxes.</p>
<p>When you've tried these two troubleshooting steps, you could also check the following:</p>
<ul>
	<li>Make sure the Bind to all Interfaces checkbox is cleared in the configuration</li>
	<li>Check for Alerts</li>
</ul>

<h4>Make sure the Bind to all Interfaces checkbox is cleared in the configuration</h4>
<p>When configuring using the Add HTTP/HTTPS Container Listener wizard, users who have Network Director might have a habit of checking the <strong>Bind to All Interfaces</strong> checkbox. For Policy Manager for DataPower it's important that you do not choose that option. DataPower has different Ethernet interfaces, and each interface has a different IP address. If you are not mapping to the correct IP address in each case, messages will not be processed correctly. Therefore you cannot bind to all interfaces for Policy Manager for DataPower.</p>
<p>The screen capture below shows this option in the Configure HTTP Container Listener page.</p>
<p><img src="assets/pmdp_03.jpg" alt="Making sure the Bind to all Interfaces checkbox is cleared" /></p>

<h4>Check for Alerts</h4>
<p>Check the Alerts tab in the Policy Manager for DataPower Console. If you see the test alert below, DataPower can communicate to the Policy Manager for DataPower server without any problem.</p>
<pre>550053—Test alert received from DataPower appliance.</pre>
<p>If there is still a communication problem between DataPower and the Policy Manager for DataPower box, you will not see the above test alert from DataPower in the Policy Manager for DataPower governed domain container's monitoring tab.</p>
<p>In this case, follow these troubleshooting steps:</p>
<ul>
	<li><strong>Verify communication by using Telnet from DataPower to Policy Manager for DataPower</strong>
	<p>Log on to the DataPower appliance and do a Telnet to the Policy Manager for DataPower server and port. Check for a successful response. If you see a failure message, it indicates that DataPower does not know about Policy Manager for DataPower.</p>
	<p>In that case, add DNS entries for the Policy Manager for DataPower host into the DataPower box.</p>
	<p><strong>Note</strong>: This is a very common cause of communication problems between Policy Manager for DataPower and DataPower. The above procedure is often the resolution for communication issues.</p></li>
</ul>
<p>If Policy Manager for DataPower can communicate to DataPower successfully, you should see the following messages on the Alerts tab in Policy Manager for DataPower:</p>
<pre>551008—Advanced Configuration Tuning metadata scripts deployed
550165—File system cleanup succeeded
550043—Appliance cleanup succeeded
550051—Policy Manager for DataPower starting up</pre>
<p>If you don't see the above messages, there is still a communication issue between Policy Manager for DataPower and DataPower.</p>
<p>When there are issues, you will also see some error messages within Policy Manager for DataPower, in the Policy Manager for DataPower governed domain container's monitoring tab. The following are common errors:</p>
<ul>
	<li>Unauthorized user</li>
	<li>Authorization failure to log into DataPower</li>
</ul>
<p>If you see these errors, follow the steps below.</p>

<h4>To verify login credentials</h4>
<ol>
	<li>Log in to the Akana Administration Console for Policy Manager for DataPower.</li>
	<li>Click the <strong>Configuration</strong> tab.</li>
	<li>In the Configuration Actions portlet, click Manage Governed DataPower Domains, and then select the modify radio button for Appropriate Governed Domain, as shown below.
	<p><img src="assets/pmdp_04.jpg" alt="Verifying login credentials" /></p></li>
	<li>Click <strong>Next</strong>.</li>
	<li>Make sure you provide the correct UserID and password to log in to the DataPower box and to the specific domain. Modify if needed, and save.</li>
	<li>When the above steps are complete, make sure you can log into the DataPower Appliance with the same credentials that you provided in the Policy Manager for DataPower Governed Domain.</li>
</ol>
<p>The above procedure verifies that you can log in with those credentials to that particular domain. You might find that you can log into the Appliance but not the domain.</p>
<p>Assign the appropriate privileges to the user prior to governing the DataPower Domain in Policy Manager for DataPower Container.</p>
<p><a href="#top">Back to top</a></p>


<h3 id="tspmdp_04_03">Incorrect Port Configurations</h3>
<p>There are a couple of common scenarios for errors in host/port configuration during installation. If you experience issues during installation, make sure:</p>
<ul>
	<li>The WS-Mex URL in the Akana Administration Console for Policy Manager for DataPower is set correctly (for instructions, see <a href="#tspmdp_04_01_05">Error in WS-Mex URL</a>).</li>
	<li>Proxy host and port for the DataPower listener service and DataPower authentication service are set correctly. See below.
	<p><img src="assets/pmdp_05.jpg" alt="Checking the Use Proxy option" /></p></li>
	<li>Proxy host and port for the DataPower listener service are configured correctly on the DataPower side. For example, if the network admin issued the values but didn't actually set them up yet, connection will fail.</li>
</ul>
<p><a href="#top">Back to top</a></p>



<h3 id="tspmdp_04_04">Incorrect Permissions on DataPower</h3>
<p>If you are seeing permission errors on DataPower during or after installation, the first thing to do is run through the steps to configure the DataPower Appliance. These steps are given below, and are also in the Install Guide.</p>
<p>All these actions are prerequisites. Installation issues are often due to missing or incomplete steps or errors in settings.</p>
<p>The configuration process is broken down into these three separate procedures which are in the following sections:</p>
<ul>
	<li>Enable the XML Management Interfaces for Policy Manager for IBM WebSphere DataPower Feature</li>
	<li>Create the DataPower Domain for Policy Manager for IBM WebSphere DataPower Feature</li>
	<li>Create a DataPower User for the Policy Manager for IBM WebSphere DataPower Feature</li>
</ul>
<p class="apidoc_note"><strong>Note</strong>: These steps configure a DataPower Appliance so that it can be managed by the Policy Manager for IBM WebSphere DataPower feature. These procedures are valid with DataPower appliance models XI52, XI50, and XS40.</p>

<h4>To enable the XML Management Interfaces for Policy Manager for IBM WebSphere DataPower Feature</h4>
<p>The following procedure uses the WebSphere DataPower WebGUI to enable the XML Management Interface via the Configure XML Management Interface screen under the <strong>Network</strong> bar. You must log in under the Default domain. Complete this task once for the entire DataPower Appliance.</p>
<ol>
	<li>Log in to the WebSphere DataPower WebGUI as Admin in the default domain.</li>
	<li>Navigate to the Network / XML Management Interface.</li>
	<li>Configure the XML Management Interface screen, as shown below.
	<p><img src="assets/pmdp_06.jpg" alt="Enabling XML Management Interfaces" /></p></li>
	<li>Click <strong>Apply</strong> and then click <strong>Save Config</strong>.</li>
</ol>

<h4>To create the DataPower Domain for Policy Manager for IBM WebSphere DataPower Feature</h4>
<p>The following procedure uses the WebSphere DataPower WebGUI to create the domain that will be managed by the Policy Manager for IBM WebSphere DataPower feature. You must log in under the Default domain. Follow these steps for each domain that will be managed by a Policy Manager for IBM WebSphere DataPower feature.</p>
<ol>
	<li>Log in to the WebSphere DataPower WebGUI as Admin in the default domain.</li>
	<li>Navigate to the Administration / Configuration / Application Domain.</li>
	<li>Click <strong>Add</strong>.</li>
	<li>Enter a name for the domain, and then select all the defaults, as shown below.
	<p><img src="assets/pmdp_07.jpg" alt="Creating the DataPower domain" /></p></li>
	<li>Click <strong>Apply</strong>, and then click <strong>Save Config</strong>.</li>
</ol>
<p>The next step is to create a new user for the new domain.</p>
<h4>To create a DataPower User for the Policy Manager for IBM WebSphere DataPower Feature</h4>
<p>The following procedure uses the WebSphere DataPower WebGUI to create a new account that the Policy Manager for IBM WebSphere DataPower feature will use to log in to this domain to manage. You can do this by granting an access level of Privileged to the user or by placing the user in a group that has Read, Write, Add, Delete, and Execute permissions in the specified domain. Follow these steps for each domain that will be managed by a Policy Manager for IBM WebSphere DataPower feature.</p>
<p class="apidoc_note"><strong>Note</strong>: The following procedure assumes you are creating a user, templateUser, for a domain template. Adjust to your environment accordingly.</p>
<ol>
	<li>Log in to the WebSphere DataPower WebGUI as Admin in the default domain.</li>
	<li>Navigate to Administration / Access / Manage User Groups.</li>
	<li>Click <strong>Add</strong>.</li>
	<li>Type in the Name of the group: templateGroup.</li>
	<li>Remove the default Access Profile.</li>
	<li>Build an Access Profile. Select myDomain for the domain, and click all five permissions. All other fields should remain as defaults. Apply the changes and click <strong>Save Config</strong>. The final result of saving the group should look something like the below:
<p><img src="assets/pmdp_08.jpg" alt="Building an access profile" /></p></li>
	<li>Click <strong>Manage User Accounts</strong>.</li>
	<li>Click <strong>Add</strong>.</li>
	<li>Enter the Name and Password.</li>
	<li>For Access Level, select <strong>Group</strong>. For the Group, select <strong>templateGroup</strong>. The entry should look something like the below:
<p><img src="assets/pmdp_09.jpg" alt="Creating the group" /></p></li>
	<li>Apply the changes and click <strong>Save Config</strong>. You should see a success message like the below:
<p><img src="assets/pmdp_10.jpg" alt="Configuration successful" /></p></li>
	<li>Log out of the WebSphere DataPower WebGUI, and then log back in to the template domain using the new user account. Change the default password to a new password and use the new username and password to configure the Policy Manager for IBM WebSphere DataPower feature that will be managing this template domain.</li>
</ol>
<p><a href="#top">Back to top</a></p>



<h2 id="tspmdp_05">Deployment Issues: Configuration Errors</h2>
<p>This section includes procedures for resolving configuration errors in Policy Manager for DataPower, including:</p>
<ul>
	<li><a href="#tspmdp_05_01">Securing the DataPower Service Using X.509 HTTPS Client Certificates</a></li>
	<li><a href="#tspmdp_05_02">Securing a DataPower Service Using Message-Level Security</a></li>
	<li>Contract Is Not Configured Correctly</li>
</ul>


<h3 id="tspmdp_05_01">Securing the DataPower Service Using X.509 HTTPS Client Certificates</h3>
<p>If you are trying to do an X.509 certificate-based authentication, follow the steps below.</p>
<h4>To secure the DataPower Service Using X.509 HTTPS Client Certificates</h4>
<ol>
	<li>Log in to the Policy Manager console.</li>
	<li>Select a Physical Service and virtualize it on the Policy Manager for DataPower container's HTTPS listener (must be an HTTPS listener).
	<p class="apidoc_note"><strong>Note</strong>: If you accidentally host an HTTPS service on an HTTP listener, the deployment will fail. In this scenario you would see this alert message in the Policy Manager for DataPower governed domain container's monitoring tab: <strong>Invalid Transport Protocol</strong>. If this happens, set up the service on an HTTPS listener, making sure all settings are correct.</p></li>
	<li>Create and activate an explicit contract.</li>
	<li>Create an organization identity and assign certificate. For example, name it consumer1.</li>
	<li>Assign the organization identity to the explicit contract.</li>
	<li>Attach the Authentication Policy, WS-Security Transport Binding Policy, and Global Detailed Auditing policy to the virtual service.</li>
	<li>Create an Authentication Policy with the configuration settings shown below:
	<p><img src="assets/pmdp_11.jpg" alt="Authentication Policy settings" /></p></li>
	<li>Create a WS-Security Transport Binding Policy with the configuration settings shown below:
	<p><img src="assets/pmdp_12.jpg" alt="WS-Security Transport Binding Policy" /></p></li>
</ol>


<h3 id="tspmdp_05_02">Securing a DataPower Service Using Message-Level Security</h3>
<p>To secure a DataPower service using message-level security, follow the steps below.</p>
<h4>To secure a DataPower service using message-level security</h4>
<ol>
	<li>Log in to the Policy Manager console.</li>
	<li>Select a physical service and virtualize it on the HTTP listener for the Policy Manager for DataPower container.</li>
	<li>Create and activate an explicit contract.</li>
	<li>Create an organization identity and assign a certificate to it; for example, name it user1.</li>
	<li>Assign the organization identity to the explicit contract, as shown below.
		<p><img src="assets/pmdp_13.jpg" alt="Assigning the organization identity" /></p></li>
	<li>Assign the certificate to the virtual service.</li>
	<li>Attach the following three policies to the virtual service, as shown below:
		<ul>
			<li>Authentication Policy</li>
			<li>WS-Security Asymmetric Binding Policy</li>
			<li>WS-Security Message Policy</li>
		</ul>
	<p><img src="assets/pmdp_14.jpg" alt="Attaching the policies" /></p></li>
	<li>Create a WS-Security message policy with the configuration shown below.
		<p><img src="assets/pmdp_15.jpg" alt="Creating the WS-Security message policy" /></p></li>
	<li>Create an Authentication Policy with the configuration shown below.
		<p><img src="assets/pmdp_16.jpg" alt="Creating the Authentication policy" /></p></li>
	<li>Create a WS-Security Asymmetric Binding Policy with the configuration shown below.
		<p><img src="assets/pmdp_17.jpg" alt="Creating the WS-Security Asymmetric Binding policy" /></p></li>
	<li>In SoapUI or other client application, add the consumer (user1) certificate to the SOAP UI SSL settings and save the preferences, as shown below.
		<p><img src="assets/pmdp_18.jpg" alt="Adding the certificate to the SSL settings" /></p>
	<p><strong>Note</strong>: If you are using a product other than soapUI, configure comparable settings in the tool that is sending the request.</p></li>
	<li>In SoapUI, import the Consumer (user1) certificate and Service Certificate to soapUI WS-Security Configurations, Keystore, as shown below.
		<p><img src="assets/pmdp_19.jpg" alt="Importing the certificates to SoapUI" /></p></li>
	<li>In SoapUI, add the signature to the Outgoing WS-Security Configuration settings. In the Parts section, for Body, Namespace, add the following:
	<pre>http://schemas.xmlsoap.org/soap/envelope/</pre>
	<p>Use your JKS file to sign the message, as shown below.</p>
		<p><img src="assets/pmdp_20.jpg" alt="Using JKS to sign the message" /></p></li>
	<li>Add encryption to the outgoing WS-Security configuration. Use the Service JKS file to encrypt the message, as shown below:
		<p><img src="assets/pmdp_21.jpg" alt="Adding encryption to the outgoing WS-Security configuration" /></p></li>
</ol>
<p><a href="#top">Back to top</a></p>



<h2 id="tspmdp_06">Deployment Issues: Deployment Errors</h2>
<p>This section provides troubleshooting and other information relating to deployment errors in DataPower. It includes:</p>
<ul>
	<li><a href="#tspmdp_06_01">Error with DataPower Port Number</a></li>
	<li><a href="#tspmdp_06_02">WSDL Error at Runtime</a></li>
	<li><a href="#tspmdp_06_03">WSDL Error on Restart</a></li>
	<li><a href="#tspmdp_06_04">Cleaning Alerts On Startup</a></li>
	<li><a href="#tspmdp_06_05">Rollback Alerts</a></li>
	<li><a href="#tspmdp_06_06">Communication Issue with DataPower</a></li>
</ul>


<h3 id="tspmdp_06_01">Error with DataPower Port Number</h3>
<p>When creating a listener, whether HTTP or HTTPS, you will need to provide a port that is available on DataPower and is unique to the listener.</p>
<p>You should have access to DataPower to make sure that the port is valid and is free. If you don't check it, and the port is in use, the deployment will fail.</p>


<h3 id="tspmdp_06_02">WSDL Error at Runtime</h3>
<p>Registering a WSDL in Policy Manager and virtualizing it on DataPower might be successful. However, if the WSDL doesn't comply with the DataPower standards, it will not work, and you will see errors in the WS-Proxy WSDL and also in the DataPower log. In that case, you will need to modify the WSDL to comply with the DataPower WSDL standards.</p>
<p>If the WSDL is successful, you will see a successful deployment message in the DataPower Governed Domain Container's monitoring tab. You will also see warning messages from DataPower, but even though there are warning messages, as long as you see the successful deployment message, the deployment will not fail.</p>


<h3 id="tspmdp_06_03">WSDL Error on Restart</h3>
<p>There is one scenario where you will get a WSDL error message but there is in fact nothing wrong.</p>
<p>When you restart Policy Manager for DataPower, there is a delay during which time the WSDL is not available to DataPower. During restart, this message is normal. Wait a little while and it will go away automatically when the restart is fully complete.</p>
<p>The reason this occurs is that when you restart Policy Manager for DataPower, objects such as handlers and WSDL files are removed and then redeployed. During the time period between removal and redeployment, DataPower cannot access the WSDL file and therefore might generate this error. Wait until the restart is fully complete and the errors will go away. Depending on the size of your deployment, including factors such as file size, number of schemas, policies, and the number of services, this might take a while. Deployment takes between 15 seconds and approximately 2.5 minutes for each service. Connection speed is also a factor.</p>


<h3 id="tspmdp_06_04">Cleaning Alerts On Startup</h3>
<p>Another type of alert you can ignore is the cleaning alerts on startup.</p>
<p>When you restart the Akana Administration Console for Policy Manager for DataPower, you might have your DataPower appliance configured to <strong>Clean appliance on startup</strong>, as shown below.</p>
<p><img src="assets/pmdp_22.jpg" alt="DataPower appliance configured to Clean appliance" /></p>
<p>If you have selected the configuration option to record all the data you clean (<strong>Record cleaning data</strong> checkbox above), you will see cleaning alerts in the Policy Manager for DataPower governed domain container's monitoring tab on startup.</p>
<p>These alerts are normal for this scenario.</p>


<h3 id="tspmdp_06_05">Rollback Alerts</h3>
<p>DataPower appliance configuration includes a <strong>Rollback on error</strong> option, as shown below.</p>
<p><img src="assets/pmdp_23.jpg" alt="Rollback on error option" /></p>
<p>If you have selected this option, and there is a failure during deployment, you will see a rollback alert message in the Policy Manager for DataPower governed domain container's monitoring tab.</p>
<p>The alert message provides information on what was missing that caused the failure, so that you can correct it and try again.</p>


<h3 id="tspmdp_06_06">Communication Issue with DataPower</h3>
<p>If Policy Manager for DataPower cannot communicate with the DataPower box, you will see many error messages. For example, you will see &quot;deployment failure&quot; messages for each initialization step, failure messages for each of the listeners, messages that trust store deployment has failed, and appliance cleanup failure messages.</p>
<p>To remedy the communication issue, first check the following basic factors:</p>
<ul>
	<li>Go to the Akana Administration Console for Policy Manager for DataPower and see if you have provided the right credentials to log in to the appliance domain.</li>
	<li>Make sure that the user credentials you are using have the right permissions/privileges to log into the domain. If the credentials are valid, but do not have sufficient permission, there will be errors.</li>
	<li>Make sure the network connectivity is working, as covered in the Installation sections earlier in this document. See <a href="#tspmdp_04">Installation Issues: Network Issues</a>.</li>
	<li>Make sure there are no issues with the firewall, as covered in the Installation sections earlier in this document. See <a href="#tspmdp_02">Firewall Rules</a>.</li>
	<li>Make sure DNS entries are correct.</li>
</ul>
<p>If the above steps do not resolve the issue, contact Akana Technical Support (see <a href="ts_pm_nd_01.htm#s01_02">Customer Support</a>) with full details of the errors, including log files.</p>
<p><a href="#top">Back to top</a></p>



<h2 id="tspmdp_07">Runtime Issues: Network Issues</h2>
<p>This section provides information about network-level issues that might come up with Policy Manager for DataPower at runtime, including:</p>
<ul>
	<li><a href="#tspmdp_07_01">Client Application Cannot Connect to DataPower Box</a></li>
	<li><a href="#tspmdp_07_02">DataPower Cannot Communicate with Back-End ESB Server</a></li>
</ul>


<h3 id="tspmdp_07_01">Client Application Cannot Connect to DataPower Box</h3>
<p>If the client sending the request cannot see the DataPower box, the client cannot send the message or get the response. This issue must be fixed at the network level.</p>


<h3 id="tspmdp_07_02">DataPower Cannot Communicate with Back-End ESB Server</h3>
<p>It might happen that DataPower can communicate with Policy Manager for DataPower and Policy Manager, but cannot communicate with the back-end ESB server.</p>
<p>In this case, the client sends the request, Policy Manager for DataPower tries to process it, but DataPower cannot connect to the ESB and get the response.</p>
<p>Communication between the DataPower box and the ESB servers is essential for Policy Manager for DataPower to operate correctly.</p>
<p><a href="#top">Back to top</a></p>



<h2 id="tspmdp_08">Runtime Issues: Security Issues</h2>
<p>Security issues that might come up with Policy Manager for DataPower include:</p>
<ul>
	<li><a href="#tspmdp_08_01">Anonymous Contract Missing</a></li>
	<li><a href="#tspmdp_08_02">Explicit Contract Is Missing Authentication Policies</a></li>
</ul>


<h3 id="tspmdp_08_01">Anonymous Contract Missing</h3>
<p>When you are trying to send a request for the first time, you must make sure that an anonymous contract has been configured for the service. If there is no anonymous contract for the service, DataPower will fail the request saying the user is not authorized.</p>
<p>The minimum contract setup for a service is to have one anonymous contract for the service.</p>


<h3 id="tspmdp_08_02">Explicit Contract Is Missing Authentication Policies</h3>
<p>A named contract or explicit contract authorizes a specific user (organization identity) or service. For authorization purposes, in addition to having an explicit contract, two factors must be in place:</p>
<ul>
	<li>The contract must have appropriate authentication policies.</li>
	<li>The contract and the authentication policies must match.</li>
</ul>
<p>For example, if you are authenticating a specific consumer, you must also have appropriate authentication policies that require authentication of the consumer. The policies enforce the contract.</p>
<p>Example: the user sends a request with unauthorized user credentials. The user exists in the system as a consumer, and therefore passes authentication, but no contract has been defined that authorizes that specific consumer. Authorization fails, and DataPower fails the request. Both steps are needed.</p>
<p>For all requests that fail during runtime, error messages are generated and can be seen in the monitoring tab for the virtual service.</p>
<p><a href="#top">Back to top</a></p>



<h2 id="tspmdp_09">Runtime Issues: Configuration Issues</h2>
<p>This section provides information about configuration issues that might come up with Policy Manager for DataPower, including:</p>
<ul>
	<li><a href="#tspmdp_09_01">CA Certificate Chain Missing (HTTPS)</a></li>
	<li><a href="#tspmdp_09_02">Incorrectly-Formatted Messages (from Client)</a></li>
	<li><a href="#tspmdp_09_03">Message Is Missing Request Parameters</a></li>
	<li><a href="#tspmdp_09_04">Issue With Timestamp in Message-Level Signature</a></li>
</ul>


<h3 id="tspmdp_09_01">CA Certificate Chain Missing (HTTPS)</h3>
<p>It's important that all the Root and Sub CA certificates are imported into the Policy Manager Trust Store. DataPower does a complete Certificate Chain validation, so if any one of the certificates involved in a Root/Sub CA Chain is missing, any security use case involving the certificate issued by this CA will fail.</p>


<h3 id="tspmdp_09_02">Incorrectly-Formatted Messages (from Client)</h3>
<p>DataPower is very strict about message format. If messages do not exactly match the schema format, validation will fail. Here are two examples that sometimes occur:</p>
<ul>
	<li><a href="#tspmdp_09_02">Message Is Missing Request Parameters</a></li>
	<li><a href="#tspmdp_09_03">Issue With Timestamp in Message-Level Signature</a></li>
</ul>


<h3 id="tspmdp_09_03">Message Is Missing Request Parameters</h3>
<p>If a message is missing one or more request parameters, or if there is an invalid character in the request message for any other reason, it will fail schema validation by DataPower.</p>
<p>Let's say for example you are using soapUI as a client for testing. In some cases, when a user registers a service from Policy Manager and is using soapUI for testing, the user registers the same service inside soapUI and then just clicks <strong>Run</strong> to test the service in soapUI. However, values might be needed in the request message. If a value is missing, this results in a question mark in the request message. The question mark is an invalid character, so the message fails validation.</p>
<p>When testing in soapUI or any other test client, make sure that you provide values for all required parameters.</p>


<h3 id="tspmdp_09_04">Issue With Timestamp in Message-Level Signature</h3>
<p>In some cases you might encounter difficulties with message-level signatures during testing.</p>
<p>Let's say you configure the policy for your service in such a way that the service expects a timestamp with the security configuration. You then go to soapUI and send a test request with the timestamp. The test request would be successful in Network Director but would fail in DataPower.</p>
<p>DataPower expects the timestamp element to be inside the digital signature element, but soapUI puts the timestamp at the beginning or end of the security header.</p>
<p>In this scenario, all elements are present, but not in the expected sequence, so the message fails validation.</p>
<p>If you encounter this difficulty, and you need to include the timestamp, you can put the timestamp inside the digital signature manually, or else write a custom client for this scenario.</p>
<p>Alternatively, if you don't have a requirement to include the timestamp, you can remove it from the policy configuration and send the request without a timestamp.</p>
<p><a href="#top">Back to top</a></p>



<hr class="divide_hr" />



<h2 id="related_topics">Related Topics</h2>
<div class="relatedlinks" id="troubleshooting">
<ul>
	<li><a href="ts_pm_nd_01.htm">Troubleshooting: Introduction</a></li>
	<li><a href="ts_pm_nd_02.htm">Troubleshooting Policy Manager</a></li>
	<li><a href="ts_pm_nd_03.htm">Troubleshooting Network Director</a></li>
	<li><a href="ts_pm_nd_04.htm">Troubleshooting Reference: Database Queries</a></li>
</ul>
<ul>
	<li><a href="ts_pm_dp.htm">Troubleshooting Policy Manager for DataPower</a></li>
</ul>
</div>
