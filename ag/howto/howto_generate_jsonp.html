<!DOCTYPE html>
<html>
<head>
<title>howto_generate_jsonp</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<hr />
<p>layout: page
title: How to Generate a JSONP Response
description: A how to guide for mediating responses to JSONP
product: ag
category: learn
sub-nav-class: Mediation
weight: 05
type: page</p>
<h2>nav-title: Generate JSONP Response</h2>
<h2>How to Generate a JSONP Response</h2>
<p>This article provides a script policy that will generate a JSONP response on demand.  It is driven by 2 things:</p>
<ol>
<li>The Accept Header - if Accept is set to <strong>application/javascript</strong> then this will generate JSONP</li>
<li>The jsonp query param - if there is a <strong>jsonp</strong> query param present, then this script will use the param value as the wrapping function name.  If not, then it will just default to <strong>jsonFunction</strong>.</li>
</ol>
<p>There are a few subtleties in this script.</p>
<ol>
<li>
<p>It has to use information that is only available on the request, in the response processing, so it extracts these things (the accept header and the jsonp param) during request message processing and stores them in the exchange.</p>
</li>
<li>
<p>If the returned content isn't already JSON, then it will mediate it to JSON by normalizing it to XML and then serializing it.</p>
</li>
<li>
<p>If the returned content is already application/javascript then the script won't do anything.</p>
</li>
</ol>
<p>To make this work, you simply need to create an operational script policy using the following self-contained script, and then attach this policy to your virtual service.</p>
<p>```javascript
// Get the message and the exchange
var msg = messageContext.getMessage();
var exg = messageContext.getExchange();</p>
<p>// Are we dealing with a request, response or fault
switch(messageContext.getParameterType())
{
	case 0:
		auditLog.debug(&quot;Request Message&quot;);</p>
<pre><code>    // Get the Accept header and store it in the exchange
    var accept = String(msg.getTransportHeaders().get(&quot;Accept&quot;).getValue());
    exg.setProperty(&quot;accept.header&quot;, accept);

    // See if there is a jsonp query param
    var queryString = String(msg.getProperty(&quot;com.soa.message.TRANSPORT_QUERY&quot;));
    var jsonpFunction = queryString.match(/jsonp=([^\&amp;]*)/im);
    if (! jsonpFunction) {
        jsonpFunction = [&quot;empty&quot;, &quot;jsonpFunction&quot;];
    }
    // store the jsonp function name in the exchange
    exg.setProperty(&quot;jsonp.function&quot;, jsonpFunction[1]);

    break;
case 1:
    auditLog.debug(&quot;Response Message&quot;);

    // Get the Accept Header from the exchange
    var accept = exg.getProperty(&quot;accept.header&quot;);

    // If the header is looking for application/javascript then we will mediate
    if (accept == &quot;application/javascript&quot;) {
        // if we don't already have javascript content
        if (msg.getContentType() != &quot;application/javascript&quot;) {
            // make sure we have JSON
            if (msg.getContentType() != &quot;application/json&quot;) {
                var content = msg.normalize();
                var jsonContent = serializer.read(content.getContentAsString());
                msg.setStringContent(jsonContent);
            }
            // Wrap the JSON result in the jsonp function name
            var jsonpContent = exg.getProperty(&quot;jsonp.function&quot;) + &quot;(&quot; + msg.getContentAsString() + &quot;);&quot;;
            msg.setStringContent(jsonpContent);
            msg.setContentType(&quot;application/javascript&quot;);
        }
    }

    break;
default:
    auditLog.debug(&quot;Fault&quot;);
</code></pre>

<p>}
```</p>
<p>Happy JSONP Generation.</p>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
